<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="format-detection" content="telephone=no">
    <title>Just Staring</title>
    <style>
        /* é˜²æ­¢iOS Safariè§†å£å˜åŒ–å¯¼è‡´çš„é—ªçƒ */
        html, body {
            position: fixed;
            overflow: hidden;
            width: 100%;
            height: 100%;
            -webkit-overflow-scrolling: touch;
        }
        
        body {
            font-family: -apple-system, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 0;
            height: 100vh;
            height: 100dvh;
        }
        
        .app-container {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
            padding: 20px;
            padding: max(20px, env(safe-area-inset-top)) max(20px, env(safe-area-inset-right)) max(20px, env(safe-area-inset-bottom)) max(20px, env(safe-area-inset-left));
            box-sizing: border-box;
        }
        
        .container {
            flex: 1;
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
            min-height: 0;
        }
        
        .header {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 15px;
            text-align: center;
            flex-shrink: 0;
        }
        
        .header h1 {
            font-size: 20px;
            margin-bottom: 5px;
        }
        
        .content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            min-height: 0;
        }
        
        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .btn {
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        
        .btn:hover {
            transform: translateY(-2px);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-blue { background: linear-gradient(45deg, #4facfe, #00f2fe); color: white; }
        .btn-green { background: linear-gradient(45deg, #43e97b, #38f9d7); color: white; }
        .btn-orange { background: linear-gradient(45deg, #fa709a, #fee140); color: white; }
        .btn-gray { background: linear-gradient(45deg, #a8edea, #fed6e3); color: #333; }
        .btn-red { background: linear-gradient(45deg, #ff6b6b, #ee5a24); color: white; }
        
        .game-area {
            display: none;
        }
        
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
            justify-content: center;
        }
        
        .controls .btn {
            padding: 8px 12px;
            font-size: 12px;
        }
        
        .table-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            overflow: auto;
            max-height: 60vh;
            -webkit-overflow-scrolling: touch;
        }
        
        .score-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 400px;
        }
        
        .score-table td {
            padding: 8px;
            text-align: center;
            border: 1px solid #ddd;
            font-size: 12px;
        }
        
        .name-row {
            background: #e9ecef;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 5;
        }
        
        .total-row {
            background: #d4edda;
            font-weight: bold;
            border-bottom: 2px solid #28a745;
            position: sticky;
            top: 33px;
            z-index: 4;
        }
        
        .positive { color: #28a745; font-weight: bold; }
        .negative { color: #dc3545; font-weight: bold; }
        .winner { background: #d1ecf1; }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            -webkit-overflow-scrolling: touch;
        }
        
        .modal-box {
            position: absolute;
            top: 20%;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 20px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            max-height: 70vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .close {
            float: right;
            font-size: 24px;
            cursor: pointer;
            color: #999;
            -webkit-tap-highlight-color: transparent;
        }
        
        .input-group {
            margin: 15px 0;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .input-group input, .input-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            -webkit-appearance: none;
            box-sizing: border-box;
        }
        
        .score-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        
        .score-item {
            text-align: center;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            transition: all 0.3s ease;
        }
        
        .score-item input {
            width: 60px;
            text-align: center;
            font-weight: bold;
            -webkit-appearance: none;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        
        .score-item input:focus {
            border-color: #4facfe;
            box-shadow: 0 0 5px rgba(79, 172, 254, 0.3);
            outline: none;
        }
        
        .score-item.current-input {
            background: linear-gradient(45deg, #e3f2fd, #f3e5f5);
            border: 2px solid #4facfe;
            transform: scale(1.05);
        }
        
        .input-hint {
            font-size: 11px;
            color: #666;
            margin-top: 5px;
            text-align: center;
        }
        
        .player-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
        }
        
        .player-card {
            background: #f8f9fa;
            padding: 8px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .player-card button {
            background: #dc3545;
            color: white;
            border: none;
            padding: 2px 6px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 10px;
            -webkit-tap-highlight-color: transparent;
        }

        .game-status-card {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            text-align: center;
        }

        .choice-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }

        .choice-buttons .btn {
            padding: 12px;
            font-size: 14px;
        }

        .detail-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .detail-buttons .btn {
            padding: 10px 15px;
            font-size: 13px;
        }

        .temp-backup-area {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px dashed #dee2e6;
        }

        .custom-alert {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 2000;
            max-width: 90%;
            width: 350px;
            text-align: center;
        }

        .custom-prompt {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 2000;
            max-width: 90%;
            width: 350px;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1999;
        }

        @media screen and (min-width: 768px) {
            .app-container {
                padding: 20px;
            }
            
            .container {
                max-height: calc(100vh - 40px);
            }
        }

        @supports (-webkit-overflow-scrolling: touch) {
            body {
                position: fixed;
                overflow: hidden;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="container">
            <div class="header" id="mainHeader">
                <h1>ğŸ¤” Just Staring</h1>
                <div id="gameStatus">æ¬¢è¿ä½¿ç”¨ | è¯·é€‰æ‹©åŠŸèƒ½</div>
            </div>
            
            <div class="content">
                <div id="mainMenu">
                    <h3 style="text-align: center; margin-bottom: 20px;">é€‰æ‹©åŠŸèƒ½</h3>
                    <div class="menu-grid">
                        <button class="btn btn-blue" onclick="startGame()">å¼€å§‹ç‰Œå±€</button>
                        <button class="btn btn-orange" onclick="showPlayers()">ç©å®¶ç®¡ç†</button>
                        <button class="btn btn-gray" onclick="showHistory()">å†å²è®°å½•</button>
                        <button class="btn btn-green" onclick="showDataBackup()">æ•°æ®å¤‡ä»½</button>
                    </div>
                </div>
                
                <div id="gameArea" class="game-area">
                    <div class="controls" style="background: linear-gradient(45deg, #ff6b6b, #ee5a24); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                        <div style="text-align: center; color: white; font-weight: bold; margin-bottom: 10px;" id="gameStatus2">ç‰Œå±€ä¿¡æ¯</div>
                        <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
                            <button class="btn btn-green" onclick="addScore()">åˆ†å€¼è®°å½•</button>
                            <button class="btn btn-gray" onclick="checkReturnHome()">è¿”å›ä¸»é¡µ</button>
                            <button class="btn btn-orange" onclick="endGame()">ç»“æŸç‰Œå±€</button>
                            <button class="btn btn-gray" onclick="showPlayers()">ç©å®¶ç®¡ç†</button>
                        </div>
                    </div>
                    
                    <div id="familyArea" style="display: none;">
                        <div class="table-container">
                            <h4 style="text-align: center; margin-bottom: 10px;">å®¶åº­ç§¯åˆ†</h4>
                            <table class="score-table" id="familyTable">
                                <tbody id="familyBody"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <h4 style="text-align: center; margin-bottom: 10px;">ä¸ªäººç§¯åˆ†</h4>
                        <table class="score-table" id="gameTable">
                            <tbody id="gameBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- åˆ†å€¼è®°å½•å¼¹çª— -->
    <div id="scoreModal" class="modal">
        <div class="modal-box">
            <span class="close" onclick="closeModal('scoreModal')">&times;</span>
            <h3 id="scoreModalTitle">è®°å½•åˆ†å€¼</h3>
            
            <div style="background: #e8f5e8; padding: 10px; border-radius: 8px; margin: 10px 0; text-align: center;">
                <div class="input-group">
                    <label style="color: #28a745;">ğŸ† è·èƒœè€…</label>
                    <select id="winner" style="font-size: 16px; font-weight: bold;">
                        <option value="">é€‰æ‹©è·èƒœè€…</option>
                    </select>
                </div>
            </div>
            
            <div id="scoreInputs" class="score-grid"></div>
            
            <div class="input-hint">
                ğŸ’¡ è¾“å…¥å®ŒæˆåæŒ‰å›è½¦é”®è‡ªåŠ¨è·³è½¬ä¸‹ä¸€ä½ï¼Œæˆ–åœ¨æœ€åä¸€ä½ç›´æ¥ä¿å­˜
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button class="btn btn-green" onclick="saveScore()">ç¡®è®¤</button>
                <button class="btn btn-gray" onclick="closeModal('scoreModal')">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- ç©å®¶ç®¡ç†å¼¹çª— -->
    <div id="playerModal" class="modal">
        <div class="modal-box">
            <span class="close" onclick="closeModal('playerModal')">&times;</span>
            <h3>ç©å®¶ç®¡ç†</h3>
            
            <div class="input-group">
                <label>å§“å:</label>
                <input type="text" id="playerName" placeholder="è¾“å…¥å§“å">
            </div>
            <div class="input-group">
                <label>å®¶åº­:</label>
                <input type="text" id="playerFamily" placeholder="å®¶åº­åç§°(å¯é€‰)">
            </div>
            
            <button class="btn btn-green" onclick="addPlayer()">æ·»åŠ </button>
            
            <h4 style="margin-top: 20px;">å‚ä¸è€…åˆ—è¡¨:</h4>
            <div id="playerList" class="player-grid"></div>
        </div>
    </div>

    <!-- å†å²è®°å½•å¼¹çª— -->
    <div id="historyModal" class="modal">
        <div class="modal-box" style="max-width: 800px;">
            <span class="close" onclick="closeModal('historyModal')">&times;</span>
            <h3>å†å²è®°å½•</h3>
            <div id="historyList"></div>
        </div>
    </div>

    <!-- ç¡®è®¤åˆ é™¤å¼¹çª— -->
    <div id="confirmModal" class="modal">
        <div class="modal-box" style="max-width: 350px;">
            <h3 id="confirmModalTitle">ç¡®è®¤åˆ é™¤</h3>
            <p id="confirmMessage" style="white-space: pre-line;"></p>
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button class="btn btn-red" onclick="confirmAction()">ç¡®è®¤</button>
                <button class="btn btn-gray" onclick="closeModal('confirmModal')">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- è¿”å›ä¸»é¡µå¼¹çª— -->
    <div id="returnHomeModal" class="modal">
        <div class="modal-box" style="max-width: 350px;">
            <span class="close" onclick="closeModal('returnHomeModal')">&times;</span>
            <h3>ğŸ® å½“å‰ç‰Œå±€å¤„ç†</h3>
            
            <div class="game-status-card">
                <div><strong>ç‰Œå±€åç§°ï¼š</strong><span id="currentGameName"></span></div>
                <div><strong>å‰¯ç‰Œæ•°ï¼š</strong><span id="currentRoundsCount"></span></div>
            </div>
            
            <p style="text-align: center; color: #666; margin: 15px 0;">
                æ£€æµ‹åˆ°æ­£åœ¨è¿›è¡Œçš„ç‰Œå±€ï¼Œè¯·é€‰æ‹©å¤„ç†æ–¹å¼ï¼š
            </p>
            
            <div class="choice-buttons">
                <button class="btn btn-green" onclick="continueCurrentGame()">
                    ğŸ¯ ç»§ç»­å½“å‰ç‰Œå±€
                </button>
                <button class="btn btn-blue" onclick="saveAndReturnHome()">
                    ğŸ’¾ ç»“æŸå¹¶ä¿å­˜ç‰Œå±€
                </button>
                <button class="btn btn-red" onclick="discardAndReturnHome()">
                    ğŸ—‘ï¸ æ”¾å¼ƒå½“å‰ç‰Œå±€
                </button>
            </div>
        </div>
    </div>

    <!-- æ•°æ®å¤‡ä»½å¼¹çª— -->
    <div id="dataBackupModal" class="modal">
        <div class="modal-box" style="max-width: 350px;">
            <span class="close" onclick="closeModal('dataBackupModal')">&times;</span>
            <h3>ğŸ’¾ æ•°æ®å¤‡ä»½</h3>
            <p style="text-align: center; color: #999; font-size: 12px; margin: 5px 0;">å¹´åº¦æ•°æ®ç®¡ç†</p>
            
            <p style="text-align: center; color: #666; margin: 15px 0;">
                è¯·é€‰æ‹©å¤‡ä»½æ“ä½œï¼š
            </p>
            
            <div class="choice-buttons">
                <button class="btn btn-green" onclick="exportYearlyData()">
                    ğŸ“¤ å¯¼å‡ºæ•°æ®
                    <br><small style="opacity: 0.8;">æŒ‰å¹´åº¦å¯¼å‡ºå†å²è®°å½•</small>
                </button>
                <button class="btn btn-orange" onclick="importYearlyData()">
                    ğŸ“¥ å¯¼å…¥æ•°æ®
                    <br><small style="opacity: 0.8;">ä»å¤‡ä»½æ–‡ä»¶æ¢å¤æ•°æ®</small>
                </button>
            </div>
            
            <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px; font-size: 12px; color: #666;">
                <strong>è¯´æ˜ï¼š</strong><br>
                â€¢ å¯¼å‡ºï¼šæŒ‰å¹´åº¦å¤‡ä»½å†å²è®°å½•å¹¶æ¸…ç†ç©ºé—´<br>
                â€¢ å¯¼å…¥ï¼šæ¢å¤å¹´åº¦å¤‡ä»½æ–‡ä»¶ä¸­çš„æ¸¸æˆè®°å½•
            </div>
        </div>
    </div>

    <script>
        var players = JSON.parse(localStorage.getItem('players') || '[]');
        var gameHistory = JSON.parse(localStorage.getItem('gameHistory') || '[]');
        var currentGame = null;
        var playerToDelete = null;
        var gameToDelete = null;
        var editingIndex = -1;
        var currentInputIndex = 0;
        var inputOrder = [];

        // é˜²æ­¢iOS Safariè§†å£å˜åŒ–çš„å¤„ç†
        function preventViewportBounce() {
            document.addEventListener('touchmove', function(e) {
                if (e.target.closest('.content') || e.target.closest('.modal-box')) {
                    return;
                }
                e.preventDefault();
            }, { passive: false });

            let lastTouchEnd = 0;
            document.addEventListener('touchend', function(event) {
                const now = (new Date()).getTime();
                if (now - lastTouchEnd <= 300) {
                    event.preventDefault();
                }
                lastTouchEnd = now;
            }, false);

            function setViewportHeight() {
                const vh = window.innerHeight * 0.01;
                document.documentElement.style.setProperty('--vh', `${vh}px`);
            }

            setViewportHeight();
            
            let resizeTimeout;
            window.addEventListener('resize', function() {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(setViewportHeight, 150);
            });
        }

        // ä¿å­˜å½“å‰è¿›è¡Œä¸­çš„ç‰Œå±€åˆ°ä¸´æ—¶å­˜å‚¨
        function saveCurrentGameToTemp() {
            if (currentGame && currentGame.rounds && currentGame.rounds.length > 0) {
                localStorage.setItem('currentGameInProgress', JSON.stringify(currentGame));
            }
        }

        // ä»ä¸´æ—¶å­˜å‚¨åŠ è½½æœªå®Œæˆçš„ç‰Œå±€
        function loadCurrentGameFromTemp() {
            var saved = localStorage.getItem('currentGameInProgress');
            if (saved) {
                try {
                    var tempGame = JSON.parse(saved);
                    if (tempGame && tempGame.rounds && tempGame.rounds.length > 0) {
                        currentGame = tempGame;
                        updateScoreTable();
                        customAlert('å·²æ¢å¤ä¸Šæ¬¡æœªå®Œæˆçš„ç‰Œå±€è®°å½•');
                    }
                } catch (e) {
                    localStorage.removeItem('currentGameInProgress');
                }
            }
        }

        // è‡ªå®šä¹‰å¼¹çª—å‡½æ•°
        function customAlert(message, callback) {
            var existingAlert = document.querySelector('.custom-alert');
            var existingOverlay = document.querySelector('.overlay');
            if (existingAlert) existingAlert.remove();
            if (existingOverlay) existingOverlay.remove();

            var overlay = document.createElement('div');
            overlay.className = 'overlay';
            
            var alertBox = document.createElement('div');
            alertBox.className = 'custom-alert';
            alertBox.innerHTML = 
                '<div style="margin-bottom: 20px; line-height: 1.5;">' + message + '</div>' +
                '<button class="btn btn-blue" onclick="closeCustomAlert()">ç¡®è®¤</button>';
            
            document.body.appendChild(overlay);
            document.body.appendChild(alertBox);
            
            window.customAlertCallback = callback;
        }

        function closeCustomAlert() {
            var alertBox = document.querySelector('.custom-alert');
            var overlay = document.querySelector('.overlay');
            if (alertBox) alertBox.remove();
            if (overlay) overlay.remove();
            
            if (window.customAlertCallback) {
                window.customAlertCallback();
                window.customAlertCallback = null;
            }
        }

        function customConfirm(message, onConfirm, onCancel) {
            var existingAlert = document.querySelector('.custom-alert');
            var existingOverlay = document.querySelector('.overlay');
            if (existingAlert) existingAlert.remove();
            if (existingOverlay) existingOverlay.remove();

            var overlay = document.createElement('div');
            overlay.className = 'overlay';
            
            var confirmBox = document.createElement('div');
            confirmBox.className = 'custom-alert';
            confirmBox.innerHTML = 
                '<div style="margin-bottom: 20px; line-height: 1.5;">' + message + '</div>' +
                '<div style="display: flex; gap: 10px; justify-content: center;">' +
                '<button class="btn btn-green" onclick="handleCustomConfirm(true)">ç¡®è®¤</button>' +
                '<button class="btn btn-gray" onclick="handleCustomConfirm(false)">å–æ¶ˆ</button>' +
                '</div>';
            
            document.body.appendChild(overlay);
            document.body.appendChild(confirmBox);
            
            window.customConfirmCallback = onConfirm;
            window.customCancelCallback = onCancel;
        }

        function handleCustomConfirm(confirmed) {
            var confirmBox = document.querySelector('.custom-alert');
            var overlay = document.querySelector('.overlay');
            if (confirmBox) confirmBox.remove();
            if (overlay) overlay.remove();
            
            if (confirmed && window.customConfirmCallback) {
                window.customConfirmCallback();
            } else if (!confirmed && window.customCancelCallback) {
                window.customCancelCallback();
            }
            
            window.customConfirmCallback = null;
            window.customCancelCallback = null;
        }

        function customPrompt(message, defaultValue, onConfirm, onCancel) {
            var existingPrompt = document.querySelector('.custom-prompt');
            var existingOverlay = document.querySelector('.overlay');
            if (existingPrompt) existingPrompt.remove();
            if (existingOverlay) existingOverlay.remove();

            var overlay = document.createElement('div');
            overlay.className = 'overlay';
            
            var promptBox = document.createElement('div');
            promptBox.className = 'custom-prompt';
            promptBox.innerHTML = 
                '<div style="margin-bottom: 15px; line-height: 1.5;">' + message + '</div>' +
                '<input type="text" id="customPromptInput" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 15px;" value="' + (defaultValue || '') + '">' +
                '<div style="display: flex; gap: 10px; justify-content: center;">' +
                '<button class="btn btn-green" onclick="handleCustomPrompt(true)">ç¡®è®¤</button>' +
                '<button class="btn btn-gray" onclick="handleCustomPrompt(false)">å–æ¶ˆ</button>' +
                '</div>';
            
            document.body.appendChild(overlay);
            document.body.appendChild(promptBox);
            
            setTimeout(function() {
                document.getElementById('customPromptInput').focus();
            }, 100);
            
            window.customPromptCallback = onConfirm;
            window.customPromptCancelCallback = onCancel;
        }

        function handleCustomPrompt(confirmed) {
            var input = document.getElementById('customPromptInput');
            var value = input ? input.value : '';
            
            var promptBox = document.querySelector('.custom-prompt');
            var overlay = document.querySelector('.overlay');
            if (promptBox) promptBox.remove();
            if (overlay) overlay.remove();
            
            if (confirmed && window.customPromptCallback) {
                window.customPromptCallback(value);
            } else if (!confirmed && window.customPromptCancelCallback) {
                window.customPromptCancelCallback();
            }
            
            window.customPromptCallback = null;
            window.customPromptCancelCallback = null;
        }

        function goHome() {
            document.getElementById('mainMenu').style.display = 'block';
            document.getElementById('gameArea').style.display = 'none';
            document.getElementById('mainHeader').style.display = 'block';
            document.getElementById('gameStatus').textContent = 'æ¬¢è¿ä½¿ç”¨ | è¯·é€‰æ‹©åŠŸèƒ½';
        }

        function checkReturnHome() {
            if (!currentGame) {
                goHome();
                return;
            }

            document.getElementById('currentGameName').textContent = currentGame.name;
            document.getElementById('currentRoundsCount').textContent = currentGame.rounds.length;
            document.getElementById('returnHomeModal').style.display = 'block';
        }

        function continueCurrentGame() {
            closeModal('returnHomeModal');
        }

        function saveAndReturnHome() {
            if (currentGame) {
                gameHistory.push(JSON.parse(JSON.stringify(currentGame)));
                localStorage.setItem('gameHistory', JSON.stringify(gameHistory));
                localStorage.removeItem('currentGameInProgress');
                currentGame = null;
                
                customAlert('ç‰Œå±€å·²ä¿å­˜åˆ°å†å²è®°å½•ï¼');
            }
            closeModal('returnHomeModal');
            goHome();
        }

        function discardAndReturnHome() {
            customConfirm('ç¡®å®šè¦æ”¾å¼ƒå½“å‰ç‰Œå±€å—ï¼Ÿæ‰€æœ‰æ•°æ®å°†ä¸¢å¤±ï¼', function() {
                localStorage.removeItem('currentGameInProgress');
                currentGame = null;
                closeModal('returnHomeModal');
                goHome();
            });
        }

        function startGame() {
            if (players.length < 2) {
                customAlert('è‡³å°‘éœ€è¦2ä¸ªç©å®¶ï¼', function() {
                    showPlayers();
                });
                return;
            }

            localStorage.removeItem('currentGameInProgress');
            
            try {
                var today = new Date();
                var month = today.getMonth() + 1;
                var day = today.getDate();
                var dateStr = today.getFullYear() + '-' + 
                             (month < 10 ? '0' + month : month) + '-' + 
                             (day < 10 ? '0' + day : day);
                
                var gameName = dateStr;
                var counter = 0;
                
                while (gameHistory.some(function(g) { return g.name === gameName; })) {
                    gameName = dateStr + String.fromCharCode(65 + counter);
                    counter++;
                }

                currentGame = {
                    name: gameName,
                    date: new Date().toISOString(),
                    players: JSON.parse(JSON.stringify(players)),
                    rounds: [],
                    scores: {}
                };

                for (var i = 0; i < players.length; i++) {
                    currentGame.scores[players[i].name] = 0;
                }

                document.getElementById('gameStatus2').textContent = 'ç‰Œå±€: ' + gameName + ' | å‰¯ç‰Œæ•°: 0';
                document.getElementById('mainMenu').style.display = 'none';
                document.getElementById('mainHeader').style.display = 'none';
                document.getElementById('gameArea').style.display = 'block';

                updateTables();
                
            } catch (error) {
                customAlert('å¼€å§‹ç‰Œå±€æ—¶å‡ºç°é”™è¯¯: ' + error.message);
            }
        }

        function endGame() {
            if (!currentGame) return;
            if (currentGame.rounds.length === 0) {
                customConfirm('è¿˜æ²¡è®°å½•ä»»ä½•å‰¯ç‰Œï¼Œç¡®å®šç»“æŸï¼Ÿ', function() {
                    goHome();
                    currentGame = null;
                });
                return;
            }
            customConfirm('ç¡®å®šç»“æŸå¹¶ä¿å­˜ç‰Œå±€ï¼Ÿ', function() {
                gameHistory.push(JSON.parse(JSON.stringify(currentGame)));
                localStorage.setItem('gameHistory', JSON.stringify(gameHistory));
                localStorage.removeItem('currentGameInProgress');
                currentGame = null;
                goHome();
                customAlert('ç‰Œå±€å·²ä¿å­˜ï¼');
            });
        }

        function addScore() {
            if (!currentGame) return;

            editingIndex = -1;
            currentInputIndex = 0;
            inputOrder = [];
            document.getElementById('scoreModalTitle').textContent = 'è®°å½•åˆ†å€¼';

            var select = document.getElementById('winner');
            select.innerHTML = '<option value="">é€‰æ‹©è·èƒœè€…</option>';
            for (var i = 0; i < players.length; i++) {
                select.innerHTML += '<option value="' + players[i].name + '">' + players[i].name + '</option>';
            }

            updateScoreInputs('');
            select.onchange = function() { updateScoreInputs(this.value); };
            
            document.getElementById('scoreModal').style.display = 'block';
        }

        function updateScoreInputs(winner) {
            var div = document.getElementById('scoreInputs');
            div.innerHTML = '';
            inputOrder = [];
            currentInputIndex = 0;

            if (!winner) {
                div.innerHTML = '<p style="text-align: center; color: #666;">è¯·å…ˆé€‰æ‹©è·èƒœè€…</p>';
                return;
            }

            var inputIndex = 0;
            for (var i = 0; i < players.length; i++) {
                if (players[i].name !== winner) {
                    var scoreItem = document.createElement('div');
                    scoreItem.className = 'score-item';
                    scoreItem.innerHTML = 
                        '<label>' + players[i].name + '</label>' +
                        '<input type="number" id="score_' + players[i].name + '" placeholder="0" min="0" inputmode="numeric" data-player="' + players[i].name + '" data-index="' + inputIndex + '">';
                    
                    div.appendChild(scoreItem);
                    inputOrder.push(players[i].name);
                    inputIndex++;
                }
            }

            setTimeout(function() {
                addInputEventListeners();
                focusCurrentInput();
            }, 100);
        }

        function addInputEventListeners() {
            for (var i = 0; i < inputOrder.length; i++) {
                var input = document.getElementById('score_' + inputOrder[i]);
                if (input) {
                    input.addEventListener('keydown', handleInputKeydown);
                    input.addEventListener('focus', handleInputFocus);
                    input.addEventListener('blur', handleInputBlur);
                }
            }
        }

        function handleInputKeydown(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                
                var currentIndex = parseInt(event.target.getAttribute('data-index'));
                
                if (currentIndex < inputOrder.length - 1) {
                    currentInputIndex = currentIndex + 1;
                    focusCurrentInput();
                } else {
                    saveScore();
                }
            }
        }

        function handleInputFocus(event) {
            var currentIndex = parseInt(event.target.getAttribute('data-index'));
            currentInputIndex = currentIndex;
            updateInputHighlight();
        }

        function handleInputBlur(event) {
            var scoreItems = document.querySelectorAll('.score-item');
            scoreItems.forEach(function(item) {
                item.classList.remove('current-input');
            });
        }

        function focusCurrentInput() {
            if (currentInputIndex >= 0 && currentInputIndex < inputOrder.length) {
                var input = document.getElementById('score_' + inputOrder[currentInputIndex]);
                if (input) {
                    input.focus();
                    input.select();
                    updateInputHighlight();
                }
            }
        }

        function updateInputHighlight() {
            var scoreItems = document.querySelectorAll('.score-item');
            scoreItems.forEach(function(item) {
                item.classList.remove('current-input');
            });

            if (currentInputIndex >= 0 && currentInputIndex < inputOrder.length) {
                var currentInput = document.getElementById('score_' + inputOrder[currentInputIndex]);
                if (currentInput) {
                    var scoreItem = currentInput.closest('.score-item');
                    if (scoreItem) {
                        scoreItem.classList.add('current-input');
                    }
                }
            }
        }

        function saveScore() {
            var winner = document.getElementById('winner').value;
            if (!winner) {
                customAlert('è¯·é€‰æ‹©è·èƒœè€…ï¼');
                return;
            }

            if (editingIndex >= 0) {
                var oldRound = currentGame.rounds[editingIndex];
                for (var name in oldRound.scores) {
                    currentGame.scores[name] -= oldRound.scores[name];
                }
            }

            var round = { winner: winner, scores: {} };
            var total = 0;

            for (var i = 0; i < players.length; i++) {
                var name = players[i].name;
                if (name === winner) {
                    round.scores[name] = 0;
                } else {
                    var input = document.getElementById('score_' + name);
                    var score = parseInt(input.value) || 0;
                    round.scores[name] = -score;
                    currentGame.scores[name] -= score;
                    total += score;
                }
            }

            round.scores[winner] = total;
            currentGame.scores[winner] += total;

            if (editingIndex >= 0) {
                currentGame.rounds[editingIndex] = round;
                editingIndex = -1;
            } else {
                currentGame.rounds.push(round);
            }

            document.getElementById('gameStatus2').textContent = 'ç‰Œå±€: ' + currentGame.name + ' | å‰¯ç‰Œæ•°: ' + currentGame.rounds.length;

            updateTables();
            closeModal('scoreModal');
            saveCurrentGameToTemp();
        }

        function updateTables() {
            updateGameTable();
            updateFamilyTable();
        }

        function updateGameTable() {
            var body = document.getElementById('gameBody');
            body.innerHTML = '';

            if (players.length === 0) {
                body.innerHTML = '<tr><td>è¯·å…ˆæ·»åŠ ç©å®¶</td></tr>';
                return;
            }

            var nameRow = '<tr class="name-row"><td><b>å§“å</b></td>';
            for (var i = 0; i < players.length; i++) {
                var family = players[i].family ? '<br><small>(' + players[i].family + ')</small>' : '';
                nameRow += '<td><b>' + players[i].name + family + '</b></td>';
            }
            nameRow += '</tr>';
            body.innerHTML += nameRow;

            var totalRow = '<tr class="total-row"><td><b>åˆè®¡</b></td>';
            for (var i = 0; i < players.length; i++) {
                var score = currentGame ? (currentGame.scores[players[i].name] || 0) : 0;
                var css = score > 0 ? 'positive' : (score < 0 ? 'negative' : '');
                totalRow += '<td class="' + css + '"><b>' + score + '</b></td>';
            }
            totalRow += '</tr>';
            body.innerHTML += totalRow;

            if (!currentGame) return;

            for (var r = 0; r < currentGame.rounds.length; r++) {
                var round = currentGame.rounds[r];
                var row = '<tr onclick="editRound(' + r + ')" style="cursor: pointer;" title="ç‚¹å‡»ä¿®æ”¹"><td>ç¬¬' + (r + 1) + 'å‰¯</td>';
                
                for (var i = 0; i < players.length; i++) {
                    var name = players[i].name;
                    var score = round.scores[name] || 0;
                    var css = score > 0 ? 'positive winner' : (score < 0 ? 'negative' : '');
                    row += '<td class="' + css + '">' + (score > 0 ? '+' : '') + score + '</td>';
                }
                row += '</tr>';
                body.innerHTML += row;
            }
        }

        function updateFamilyTable() {
            var families = {};
            var hasFamilies = false;
            
            for (var i = 0; i < players.length; i++) {
                if (players[i].family) {
                    hasFamilies = true;
                    if (!families[players[i].family]) {
                        families[players[i].family] = [];
                    }
                    families[players[i].family].push(players[i].name);
                }
            }

            var area = document.getElementById('familyArea');
            if (!hasFamilies || !currentGame) {
                area.style.display = 'none';
                return;
            }

            area.style.display = 'block';
            var body = document.getElementById('familyBody');
            var familyNames = Object.keys(families);
            body.innerHTML = '';

            var nameRow = '<tr class="name-row"><td><b>å®¶åº­</b></td>';
            for (var i = 0; i < familyNames.length; i++) {
                var members = families[familyNames[i]].join(', ');
                nameRow += '<td><b>' + familyNames[i] + '<br><small>(' + members + ')</small></b></td>';
            }
            nameRow += '</tr>';
            body.innerHTML += nameRow;

            var totalRow = '<tr class="total-row"><td><b>åˆè®¡</b></td>';
            for (var i = 0; i < familyNames.length; i++) {
                var familyScore = 0;
                for (var j = 0; j < families[familyNames[i]].length; j++) {
                    var playerName = families[familyNames[i]][j];
                    familyScore += currentGame.scores[playerName] || 0;
                }
                var css = familyScore > 0 ? 'positive' : (familyScore < 0 ? 'negative' : '');
                totalRow += '<td class="' + css + '"><b>' + familyScore + '</b></td>';
            }
            totalRow += '</tr>';
            body.innerHTML += totalRow;
        }

        function editRound(index) {
            if (!currentGame || index >= currentGame.rounds.length) return;
            
            editingIndex = index;
            currentInputIndex = 0;
            inputOrder = [];
            var round = currentGame.rounds[index];
            document.getElementById('scoreModalTitle').textContent = 'ä¿®æ”¹ç¬¬' + (index + 1) + 'å‰¯ç‰Œ';
            
            var select = document.getElementById('winner');
            select.innerHTML = '<option value="">é€‰æ‹©è·èƒœè€…</option>';
            for (var i = 0; i < players.length; i++) {
                var selected = players[i].name === round.winner ? ' selected' : '';
                select.innerHTML += '<option value="' + players[i].name + '"' + selected + '>' + players[i].name + '</option>';
            }
            
            updateScoreInputs(round.winner);
            
            setTimeout(function() {
                for (var i = 0; i < players.length; i++) {
                    var name = players[i].name;
                    if (name !== round.winner) {
                        var input = document.getElementById('score_' + name);
                        if (input) {
                            input.value = Math.abs(round.scores[name] || 0);
                        }
                    }
                }
            }, 150);
            
            document.getElementById('scoreModal').style.display = 'block';
        }

        function showPlayers() {
            updatePlayerList();
            document.getElementById('playerModal').style.display = 'block';
        }

        function addPlayer() {
            var name = document.getElementById('playerName').value.trim();
            var family = document.getElementById('playerFamily').value.trim();

            if (!name) {
                customAlert('è¯·è¾“å…¥å§“åï¼');
                return;
            }

            if (players.some(function(p) { return p.name === name; })) {
                customAlert('ç©å®¶å·²å­˜åœ¨ï¼');
                return;
            }

            players.push({ name: name, family: family || null });
            localStorage.setItem('players', JSON.stringify(players));

            document.getElementById('playerName').value = '';
            document.getElementById('playerFamily').value = '';

            updatePlayerList();
            if (currentGame) {
                currentGame.scores[name] = 0;
                updateTables();
            }
        }

        function removePlayer(name) {
            if (currentGame && currentGame.rounds.length > 0) {
                customAlert('ç‰Œå±€è¿›è¡Œä¸­ä¸èƒ½åˆ é™¤ç©å®¶ï¼');
                return;
            }

            playerToDelete = name;
            document.getElementById('confirmModalTitle').textContent = 'ç¡®è®¤åˆ é™¤ç©å®¶';
            document.getElementById('confirmMessage').textContent = 'ç¡®å®šè¦åˆ é™¤ç©å®¶ "' + name + '" å—ï¼Ÿ';
            document.getElementById('confirmModal').style.display = 'block';
        }

        function deleteGameRecord(index) {
            if (index < 0 || index >= gameHistory.length) return;
            
            gameToDelete = index;
            var game = gameHistory[index];
            document.getElementById('confirmModalTitle').textContent = 'ç¡®è®¤åˆ é™¤ç‰Œå±€';
            document.getElementById('confirmMessage').textContent = 'ç¡®å®šè¦åˆ é™¤ç‰Œå±€ "' + game.name + '" å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼';
            document.getElementById('confirmModal').style.display = 'block';
        }

        function confirmAction() {
            if (playerToDelete) {
                players = players.filter(function(p) { 
                    return p.name !== playerToDelete; 
                });
                
                localStorage.setItem('players', JSON.stringify(players));
                updatePlayerList();
                
                if (currentGame) {
                    delete currentGame.scores[playerToDelete];
                    updateTables();
                }
                
                playerToDelete = null;
            } else if (gameToDelete !== null) {
                gameHistory.splice(gameToDelete, 1);
                localStorage.setItem('gameHistory', JSON.stringify(gameHistory));
                gameToDelete = null;
                customAlert('ç‰Œå±€è®°å½•å·²åˆ é™¤ï¼');
                showHistory();
            }
            
            closeModal('confirmModal');
        }

        function updatePlayerList() {
            var list = document.getElementById('playerList');
            list.innerHTML = '';

            if (players.length === 0) {
                list.innerHTML = '<div style="text-align: center; color: #666;">æš‚æ— ç©å®¶</div>';
                return;
            }

            for (var i = 0; i < players.length; i++) {
                var player = players[i];
                var familyText = player.family ? ' (' + player.family + ')' : '';
                
                var playerCard = document.createElement('div');
                playerCard.className = 'player-card';
                
                var playerSpan = document.createElement('span');
                playerSpan.textContent = player.name + familyText;
                
                var deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'Ã—';
                deleteBtn.title = 'åˆ é™¤ ' + player.name;
                deleteBtn.onclick = function(name) {
                    return function() {
                        removePlayer(name);
                    };
                }(player.name);
                
                playerCard.appendChild(playerSpan);
                playerCard.appendChild(deleteBtn);
                list.appendChild(playerCard);
            }
        }

        function showHistory() {
            var listDiv = document.getElementById('historyList');
            listDiv.innerHTML = '';

            if (gameHistory.length === 0) {
                listDiv.innerHTML = '<p style="text-align: center; color: #666;">æš‚æ— å†å²è®°å½•</p>';
            } else {
                for (var i = gameHistory.length - 1; i >= 0; i--) {
                    var game = gameHistory[i];
                    
                    var families = {};
                    for (var j = 0; j < game.players.length; j++) {
                        var p = game.players[j];
                        if (p.family) {
                            if (!families[p.family]) families[p.family] = 0;
                            families[p.family] += game.scores[p.name] || 0;
                        }
                    }
                    
                    var summary = Object.keys(families).map(function(f) { 
                        return f + ': ' + families[f]; 
                    }).join(' | ');
                    
                    var div = document.createElement('div');
                    div.style.marginBottom = '10px';
                    div.style.padding = '8px';
                    div.style.border = '1px solid #ddd';
                    div.style.borderRadius = '5px';
                    div.innerHTML = 
                        '<b>' + game.name + '</b><br>' +
                        (summary || 'æ— å®¶åº­æ•°æ®') +
                        '<br><button class="btn btn-blue" style="margin-top:5px;" onclick="showGameDetail(' + i + ')">è¯¦æƒ…</button>';
                    
                    listDiv.appendChild(div);
                }
            }

            var currentYear = new Date().getFullYear();
            var tempBackupDiv = document.createElement('div');
            tempBackupDiv.className = 'temp-backup-area';
            tempBackupDiv.innerHTML = 
                '<h4 style="margin-top: 0; text-align: center; color: #28a745;">æ•°æ®å¤‡ä»½</h4>' +
                '<div class="detail-buttons">' +
                '<button class="btn btn-green" onclick="createTempBackup()">å¤‡ä»½å½“å¹´æ•°æ®</button>' +
                '<button class="btn btn-orange" onclick="restoreTempBackup()">æ¢å¤å¤‡ä»½æ•°æ®</button>' +
                '</div>' +
                '<p style="font-size: 12px; color: #666; text-align: center; margin: 10px 0 0 0;">' +
                'ä¸´æ—¶å¤‡ä»½ä»…ä¿å­˜ ' + currentYear + ' å¹´æ•°æ®ï¼Œä¸åˆ é™¤åŸå§‹è®°å½•' +
                '</p>';
            
            listDiv.appendChild(tempBackupDiv);

            document.getElementById('historyModal').style.display = 'block';
        }

        function showGameDetail(index) {
            var game = gameHistory[index];
            var html = '<h4>ç‰Œå±€: ' + game.name + '</h4>';
            
            html += '<table class="score-table"><tr class="name-row"><td>å‰¯æ•°</td>';
            for (var i = 0; i < game.players.length; i++) {
                html += '<td><b>' + game.players[i].name + '</b></td>';
            }
            html += '</tr>';
            
            var totalRow = '<tr class="total-row"><td><b>åˆè®¡</b></td>';
            for (var i = 0; i < game.players.length; i++) {
                var name = game.players[i].name;
                var score = game.scores[name] || 0;
                var css = score > 0 ? 'positive' : (score < 0 ? 'negative' : '');
                totalRow += '<td class="' + css + '"><b>' + score + '</b></td>';
            }
            totalRow += '</tr>';
            html += totalRow;
            
            for (var r = 0; r < game.rounds.length; r++) {
                var round = game.rounds[r];
                html += '<tr><td>ç¬¬' + (r + 1) + 'å‰¯</td>';
                for (var i = 0; i < game.players.length; i++) {
                    var name = game.players[i].name;
                    var score = round.scores[name] || 0;
                    var css = score > 0 ? 'positive winner' : (score < 0 ? 'negative' : '');
                    html += '<td class="' + css + '">' + (score > 0 ? '+' : '') + score + '</td>';
                }
                html += '</tr>';
            }
            
            html += '</table>';
            
            html += '<div class="detail-buttons">' +
                    '<button class="btn btn-gray" onclick="showHistory()">è¿”å›åˆ—è¡¨</button>' +
                    '<button class="btn btn-red" onclick="deleteGameRecord(' + index + ')">åˆ é™¤è®°å½•</button>' +
                    '</div>';
            
            var listDiv = document.getElementById('historyList');
            listDiv.innerHTML = html;
        }

        function showDataBackup() {
            document.getElementById('dataBackupModal').style.display = 'block';
        }

        function exportYearlyData() {
            closeModal('dataBackupModal');
            
            if (gameHistory.length === 0) {
                customAlert('æš‚æ— å†å²è®°å½•å¯å¤‡ä»½ï¼');
                return;
            }
            
            var yearData = {};
            for (var i = 0; i < gameHistory.length; i++) {
                var game = gameHistory[i];
                var year = new Date(game.date).getFullYear();
                if (!yearData[year]) {
                    yearData[year] = [];
                }
                yearData[year].push(game);
            }
            
            var currentYear = new Date().getFullYear();
            var availableYears = [];
            
            for (var year in yearData) {
                if (parseInt(year) < currentYear) {
                    availableYears.push(year);
                }
            }
            
            availableYears.sort(function(a, b) { return b - a; });
            
            if (availableYears.length === 0) {
                customAlert('æš‚æ— å¯å¤‡ä»½çš„å¾€å¹´æ•°æ®ï¼Œå½“å¹´æ•°æ®è¯·ç­‰å¹´åº•å†å¤‡ä»½ã€‚');
                return;
            }
            
            var yearChoice = 'è¯·é€‰æ‹©è¦å¤‡ä»½çš„å¹´åº¦ï¼š\n\n';
            for (var i = 0; i < availableYears.length; i++) {
                var year = availableYears[i];
                var count = yearData[year].length;
                yearChoice += (i + 1) + '. ' + year + 'å¹´ (' + count + 'åœºæ¸¸æˆ)\n';
            }
            
            customPrompt(yearChoice + '\nè¯·è¾“å…¥æ•°å­—é€‰æ‹©ï¼š', '', function(choice) {
                if (!choice) return;
                
                var selectedIndex = parseInt(choice) - 1;
                if (selectedIndex < 0 || selectedIndex >= availableYears.length) {
                    customAlert('é€‰æ‹©æ— æ•ˆï¼');
                    return;
                }
                
                var selectedYear = availableYears[selectedIndex];
                var yearGames = yearData[selectedYear];
                
                var backupDate = new Date().toISOString().slice(0, 10);
                var backupFileName = selectedYear + 'å¹´åº¦å¤‡ä»½_' + backupDate + '.json';
                
                customConfirm('ç¡®è®¤å¤‡ä»½ ' + selectedYear + ' å¹´çš„ ' + yearGames.length + ' åœºæ¸¸æˆå—ï¼Ÿ\n\n' +
                           'æ–‡ä»¶åï¼š' + backupFileName + '\n' +
                           'ä¿å­˜ä½ç½®ï¼šæµè§ˆå™¨ä¸‹è½½æ–‡ä»¶å¤¹\n\n' +
                           'å¤‡ä»½åå°†ä»å†å²è®°å½•ä¸­æ¸…ç©ºè¯¥å¹´åº¦æ•°æ®ï¼\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼', function() {
                    var backupData = {
                        backupType: 'yearly',
                        year: parseInt(selectedYear),
                        backupDate: new Date().toISOString(),
                        gameCount: yearGames.length,
                        games: yearGames,
                        version: '1.0',
                        app: 'Just Staring'
                    };
                    
                    var dataStr = JSON.stringify(backupData, null, 2);
                    var dataBlob = new Blob([dataStr], {type: 'application/json;charset=utf-8'});
                    var link = document.createElement('a');
                    link.href = URL.createObjectURL(dataBlob);
                    link.download = backupFileName;
                    link.click();
                    
                    gameHistory = gameHistory.filter(function(g) {
                        return new Date(g.date).getFullYear() !== parseInt(selectedYear);
                    });
                    
                    localStorage.setItem('gameHistory', JSON.stringify(gameHistory));
                    
                    customAlert(selectedYear + ' å¹´åº¦æ•°æ®å¤‡ä»½æˆåŠŸï¼\n\n' +
                         'æ–‡ä»¶åï¼š' + backupFileName + '\n' +
                         'ä¿å­˜ä½ç½®ï¼šæµè§ˆå™¨ä¸‹è½½æ–‡ä»¶å¤¹\n' +
                         'å·²ä»å†å²è®°å½•ä¸­æ¸…ç©º ' + yearGames.length + ' åœºæ¸¸æˆã€‚\n\n' +
                         'è¯·å¦¥å–„ä¿å­˜å¤‡ä»½æ–‡ä»¶ï¼Œåˆ é™¤çš„æ•°æ®åªèƒ½é€šè¿‡å¯¼å…¥å¤‡ä»½æ–‡ä»¶æ¢å¤ã€‚');
                });
            });
        }

        function importYearlyData() {
            closeModal('dataBackupModal');
            
            var input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.style.display = 'none';
            
            input.onchange = function(event) {
                var file = event.target.files[0];
                if (!file) return;
                
                var reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        var backupData = JSON.parse(e.target.result);
                        
                        if (!backupData.backupType || backupData.backupType !== 'yearly') {
                            throw new Error('ä¸æ˜¯æœ‰æ•ˆçš„å¹´åº¦å¤‡ä»½æ–‡ä»¶');
                        }
                        
                        if (!backupData.year || !backupData.games) {
                            throw new Error('å¤‡ä»½æ–‡ä»¶æ•°æ®ä¸å®Œæ•´');
                        }
                        
                        var existingYearGames = gameHistory.filter(function(g) {
                            return new Date(g.date).getFullYear() === backupData.year;
                        });
                        
                        var confirmMsg = 'ç¡®è®¤å¯¼å…¥ ' + backupData.year + ' å¹´åº¦å¤‡ä»½å—ï¼Ÿ\n\n' +
                                       'å°†å¯¼å…¥ ' + backupData.games.length + ' åœºæ¸¸æˆ\n' +
                                       'å¤‡ä»½æ—¶é—´ï¼š' + new Date(backupData.backupDate).toLocaleString();
                        
                        if (existingYearGames.length > 0) {
                            confirmMsg += '\n\næ³¨æ„ï¼šå½“å‰å†å²ä¸­å·²æœ‰ ' + existingYearGames.length + 
                                         ' åœº ' + backupData.year + ' å¹´çš„æ¸¸æˆï¼Œå¯¼å…¥åå°†åˆå¹¶æ˜¾ç¤ºã€‚';
                        }
                        
                        customConfirm(confirmMsg, function() {
                            for (var i = 0; i < backupData.games.length; i++) {
                                gameHistory.push(backupData.games[i]);
                            }
                            
                            gameHistory.sort(function(a, b) {
                                return new Date(a.date) - new Date(b.date);
                            });
                            
                            localStorage.setItem('gameHistory', JSON.stringify(gameHistory));
                            
                            customAlert('æˆåŠŸå¯¼å…¥ ' + backupData.year + ' å¹´åº¦å¤‡ä»½ï¼\nå…± ' + backupData.games.length + ' åœºæ¸¸æˆå·²åŠ å…¥å†å²è®°å½•ã€‚');
                        });
                        
                    } catch (error) {
                        customAlert('å¯¼å…¥å¤±è´¥ï¼š' + error.message + '\n\nè¯·ç¡®ä¿é€‰æ‹©çš„æ˜¯æ­£ç¡®çš„å¹´åº¦å¤‡ä»½æ–‡ä»¶ã€‚');
                    }
                };
                
                reader.readAsText(file);
            };
            
            document.body.appendChild(input);
            input.click();
            document.body.removeChild(input);
        }

        function createTempBackup() {
            var currentYear = new Date().getFullYear();
            var lastYear = currentYear - 1;
            
            var lastYearGames = gameHistory.filter(function(g) {
                return new Date(g.date).getFullYear() === lastYear;
            });
            
            if (lastYearGames.length > 0) {
                customConfirm('å‘ç° ' + lastYear + ' å¹´æœ‰ ' + lastYearGames.length + ' åœºæ¸¸æˆè®°å½•\n\nå»ºè®®å…ˆè¿›è¡Œå¹´åº¦å¤‡ä»½æ¸…ç†ç©ºé—´ï¼Œæ˜¯å¦ç°åœ¨è¿›è¡Œå¹´åº¦å¤‡ä»½ï¼Ÿ\n\nç‚¹å‡»"ç¡®å®š"è¿›è¡Œå¹´åº¦å¤‡ä»½ï¼Œç‚¹å‡»"å–æ¶ˆ"ç»§ç»­ä¸´æ—¶å¤‡ä»½', function() {
                    closeModal('historyModal');
                    showDataBackup();
                }, function() {
                    performTempBackup();
                });
                return;
            }
            
            performTempBackup();
        }

        function performTempBackup() {
            var currentYear = new Date().getFullYear();
            
            var currentYearGames = gameHistory.filter(function(g) {
                return new Date(g.date).getFullYear() === currentYear;
            });
            
            if (currentYearGames.length === 0) {
                customAlert('å½“å‰æ²¡æœ‰ ' + currentYear + ' å¹´çš„æ¸¸æˆè®°å½•å¯ä»¥å¤‡ä»½ï¼');
                return;
            }
            
            var backupDate = new Date().toISOString().slice(0, 10);
            var backupFileName = 'ä¸´æ—¶å¤‡ä»½_' + currentYear + 'å¹´_' + backupDate + '.json';
            
            var tempBackupData = {
                backupType: 'temporary',
                year: currentYear,
                backupDate: new Date().toISOString(),
                gameCount: currentYearGames.length,
                playerCount: players.length,
                data: {
                    players: players,
                    games: currentYearGames
                },
                version: '1.0',
                app: 'Just Staring'
            };
            
            var tempBackupKey = 'tempBackup_' + currentYear;
            localStorage.setItem(tempBackupKey, JSON.stringify(tempBackupData));
            
            var dataStr = JSON.stringify(tempBackupData, null, 2);
            var dataBlob = new Blob([dataStr], {type: 'application/json;charset=utf-8'});
            var link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = backupFileName;
            link.click();
            
            customAlert('ä¸´æ—¶å¤‡ä»½æˆåŠŸï¼\n\næ–‡ä»¶åï¼š' + backupFileName + '\nä¿å­˜ä½ç½®ï¼šæµè§ˆå™¨ä¸‹è½½æ–‡ä»¶å¤¹\n\nå·²å¤‡ä»½ ' + currentYearGames.length + ' åœº ' + currentYear + ' å¹´æ¸¸æˆè®°å½•å’Œ ' + players.length + ' ä¸ªç©å®¶ä¿¡æ¯ã€‚\n\nå¤‡ä»½æ•°æ®åŒæ—¶ä¿å­˜åœ¨åº”ç”¨å†…ï¼Œå¯ç›´æ¥ä½¿ç”¨"æ¢å¤å¤‡ä»½æ•°æ®"åŠŸèƒ½ã€‚');
        }

        function restoreTempBackup() {
            var currentYear = new Date().getFullYear();
            var tempBackupKey = 'tempBackup_' + currentYear;
            var storedBackup = localStorage.getItem(tempBackupKey);
            
            if (!storedBackup) {
                var input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.style.display = 'none';
                
                input.onchange = function(event) {
                    var file = event.target.files[0];
                    if (!file) return;
                    
                    var reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            var backupData = JSON.parse(e.target.result);
                            
                            if (!backupData.backupType || backupData.backupType !== 'temporary') {
                                throw new Error('ä¸æ˜¯æœ‰æ•ˆçš„ä¸´æ—¶å¤‡ä»½æ–‡ä»¶');
                            }
                            
                            restoreFromBackupData(backupData);
                            
                        } catch (error) {
                            customAlert('æ¢å¤å¤±è´¥ï¼š' + error.message + '\n\nè¯·ç¡®ä¿é€‰æ‹©çš„æ˜¯æ­£ç¡®çš„ä¸´æ—¶å¤‡ä»½æ–‡ä»¶ã€‚');
                        }
                    };
                    
                    reader.readAsText(file);
                };
                
                customConfirm('æ²¡æœ‰æ‰¾åˆ°åº”ç”¨å†…çš„ä¸´æ—¶å¤‡ä»½æ•°æ®ã€‚\n\næ˜¯å¦è¦ä»å¤‡ä»½æ–‡ä»¶æ¢å¤ï¼Ÿ', function() {
                    document.body.appendChild(input);
                    input.click();
                    document.body.removeChild(input);
                });
                return;
            }
            
            try {
                var backupData = JSON.parse(storedBackup);
                restoreFromBackupData(backupData);
            } catch (error) {
                customAlert('æ¢å¤å¤±è´¥ï¼šå¤‡ä»½æ•°æ®å·²æŸåã€‚');
            }
        }

        function restoreFromBackupData(backupData) {
            var backupDate = new Date(backupData.backupDate).toLocaleString();
            var confirmMsg = 'ç¡®è®¤æ¢å¤ä¸´æ—¶å¤‡ä»½å—ï¼Ÿ\n\n' +
                           'å¤‡ä»½æ—¶é—´ï¼š' + backupDate + '\n' +
                           'å¤‡ä»½å¹´ä»½ï¼š' + backupData.year + ' å¹´\n' +
                           'æ¸¸æˆè®°å½•ï¼š' + backupData.gameCount + ' åœº\n' +
                           'ç©å®¶ä¿¡æ¯ï¼š' + backupData.playerCount + ' ä¸ª\n\n' +
                           'æ³¨æ„ï¼šè¿™å°†è¦†ç›–å½“å‰çš„ç©å®¶ä¿¡æ¯å’Œ ' + backupData.year + ' å¹´çš„æ¸¸æˆè®°å½•ï¼';
            
            customConfirm(confirmMsg, function() {
                players = backupData.data.players || [];
                localStorage.setItem('players', JSON.stringify(players));
                
                gameHistory = gameHistory.filter(function(g) {
                    return new Date(g.date).getFullYear() !== backupData.year;
                });
                
                for (var i = 0; i < backupData.data.games.length; i++) {
                    gameHistory.push(backupData.data.games[i]);
                }
                
                gameHistory.sort(function(a, b) {
                    return new Date(a.date) - new Date(b.date);
                });
                
                localStorage.setItem('gameHistory', JSON.stringify(gameHistory));
                
                customAlert('ä¸´æ—¶å¤‡ä»½æ¢å¤æˆåŠŸï¼\n\nå·²æ¢å¤ ' + backupData.gameCount + ' åœº ' + backupData.year + ' å¹´æ¸¸æˆè®°å½•å’Œ ' + backupData.playerCount + ' ä¸ªç©å®¶ä¿¡æ¯ã€‚');
                
                showHistory();
                updatePlayerList();
            });
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
            if (id === 'scoreModal') {
                editingIndex = -1;
                currentInputIndex = 0;
                inputOrder = [];
            }
            if (id === 'confirmModal') {
                playerToDelete = null;
                gameToDelete = null;
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.onload = function() {
            preventViewportBounce();
            
            // æ£€æŸ¥æ˜¯å¦æœ‰æœªå®Œæˆçš„ç‰Œå±€éœ€è¦æ¢å¤
            var saved = localStorage.getItem('currentGameInProgress');
            if (saved) {
                try {
                    var tempGame = JSON.parse(saved);
                    if (tempGame && tempGame.rounds && tempGame.rounds.length > 0) {
                        customConfirm('æ£€æµ‹åˆ°ä¸Šæ¬¡æœªå®Œæˆçš„ç‰Œå±€ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ\n\nç‰Œå±€: ' + tempGame.name + '\nå‰¯ç‰Œæ•°: ' + tempGame.rounds.length, function() {
                            currentGame = tempGame;
                            document.getElementById('mainMenu').style.display = 'none';
                            document.getElementById('mainHeader').style.display = 'none';
                            document.getElementById('gameArea').style.display = 'block';
                            document.getElementById('gameStatus2').textContent = 'ç‰Œå±€: ' + currentGame.name + ' | å‰¯ç‰Œæ•°: ' + currentGame.rounds.length;
                            updateTables();
                        }, function() {
                            localStorage.removeItem('currentGameInProgress');
                            goHome();
                        });
                        updatePlayerList();
                        return;
                    }
                } catch (e) {
                    localStorage.removeItem('currentGameInProgress');
                }
            }
            
            goHome();
            updatePlayerList();
        };

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
                if (event.target.id === 'scoreModal') {
                    editingIndex = -1;
                    currentInputIndex = 0;
                    inputOrder = [];
                }
                if (event.target.id === 'confirmModal') {
                    playerToDelete = null;
                    gameToDelete = null;
                }
            }
        };
    </script>
</body>
</html>
            